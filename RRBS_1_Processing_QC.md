---
title: "RRBS Processing and QC"
author: "Annat Haber"
date: '2021-05-19'
output:
  html_document:
    toc: true
    code_folding: hide
---


```r
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(message=FALSE, warning=FALSE, cache = TRUE)
```


```r
suppressPackageStartupMessages({
  library(methylKit)
  library(tidyverse)
  library(synapser)
})
```


```r
meta <- readRDS("output/RRBS/sample_meta.RDS") %>% arrange(genotype,sex, age)
```

## Linking input fastq files
Creating symbolic links to the original fastq files.  
Files are renamed as `<sample_id>.fastq.gz`. Sample ids are padded with zeros to have five digits      

```r
# original files to link to
origfiles <- c(list.files("/projects/howell-lab/00_fastq/reagaa/RRBS/20200909_20-howell-004-run2",
                        pattern=".*GT20.*.fastq.gz", full.names = TRUE),
               list.files("/projects/howell-lab/00_fastq/reagaa/RRBS/20200909_20-howell-004-run3",
                        pattern=".*GT20.*.fastq.gz", full.names = TRUE))

for (id in meta$tag_ids) {
  if (id=="48289") { ## typo in the fastq file name
      flink <- paste0("data/RRBS/", str_pad(id, 5, pad = "0"), "_R1.fastq.gz") # link name and path
      ofile <- grep("/49289_GT20", origfiles, value=TRUE) # original file name and path
      file.symlink(ofile, flink)
  } else {
      flink <- paste0("data/RRBS/", str_pad(id, 5, pad = "0"), "_R1.fastq.gz") # link name and path
      ofile <- grep(paste0("/",id,"_GT20"), origfiles, value=TRUE) # original file name and path
      file.symlink(ofile, flink)
  }
}
```

## Processing fastq Files
The fastq files are processed using the [nextflow-core methylseq pipeline](https://github.com/nf-core/methylseq), and submitted to sumner with [this script](assets/RRBS_run_nf_methylseq.sbatch).  
Reads were aligned to GRCm38 reference genome as a directional library. 

```bash
cd /projects/carter-lab/MTHFR/output/RRBS/1_Processing_QC
sbatch run_nf_methylseq.sbatch
cp run_nf_methylseq.sbatch /projects/carter-lab/MTHFR/assets/RRBS_run_nf_methylseq.sbatch
nextflow clean -f
```

## QC: Processing Pipeline
Summary reports generated by the pipeline:

```r
file.copy(from = "output/RRBS/1_Processing_QC/nf_methylseq_output/pipeline_info/results_description.html", 
          to = "./assets/RRBS_results_description.html", 
          overwrite = TRUE, recursive = FALSE, copy.mode = TRUE, copy.date = TRUE)
file.copy(from = "output/RRBS/1_Processing_QC/nf_methylseq_output/MultiQC/multiqc_report.html", 
          to = "./assets/RRBS_multiqc_report.html", 
          overwrite = TRUE, recursive = FALSE, copy.mode = TRUE, copy.date = TRUE)
```
1. [Overview of pipeline and output](assets/RRBS_results_description.html)  
2. [QC report for all steps](assets/RRBS_multiqc_report.html)   

## Generating methylation objects 
Methylation calls are extracted from the coverage files generated by bismark.  

```r
covfiles <- list.files("output/RRBS/1_Processing_QC/nf_methylseq_output/bismark_methylation_calls/methylation_coverage", full.names = TRUE)
names(covfiles) <- gsub("(\\d+)_R1_trimmed_bismark_bt2.bismark.cov.gz", "\\1", basename(covfiles))
covfiles <- as.list(covfiles[meta$sample_id])
```
Sites with less than 10x read coverage are filtered out.  
Only sites within CpG context that are covered in all samples are retained for subsequent analyses.

```r
library(tidyverse)
library(methylKit)

raw_meth <- methRead(covfiles,
           sample.id=as.list(names(covfiles)),
           assembly="mm10.p6",
           treatment=meta$treatment,
           context="CpG",
           pipeline='bismarkCoverage',
           mincov = 10
           ) %>%
  filterByCoverage(lo.count=10, lo.perc=NULL, hi.count=NULL, hi.perc=99.9)
```


```r
#raw_meth <- readRDS("output/RRBS/1_Processing_QC/raw_meth.RDS")
united_meth <-  methylKit::unite(raw_meth, destrand=FALSE)
```

Calculating percent methylation per site per sample (samples x sites matrix).

```r
site_meth <- t(percMethylation(united_meth))
# Adding positions as column names:
colnames(site_meth) <- paste(united_meth$chr, united_meth$start, sep="_")
```

## QC: Methylation distribution and read coverage {.tabset .tabset-fade .tabset-pills}
Distributions are largely the same for all samples.  
The vast majority of sites have either 0% or 100% methylation, which is what we want.  
Coverage is highly right-skewed, which tells us that we don't need to worry about PCR duplication bias. A bias would have been indicated as an additional peak on the right.

```r
for(i in 1:nrow(meta)){
  cat("### ", paste(meta$sample_id[i], meta$genotype[i], meta$sex[i], meta$age[i], sep="_"),"\n")
  cat(getMethylationStats(raw_meth[[i]], plot=TRUE, both.strands=FALSE))
  cat(getCoverageStats(raw_meth[[i]], plot=TRUE, both.strands=FALSE))
  cat('\n\n')
}
```

###  34164_CC_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-1.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-2.png" width="50%" />

###  34165_CC_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-3.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-4.png" width="50%" />

###  34195_CC_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-5.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-6.png" width="50%" />

###  34196_CC_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-7.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-8.png" width="50%" />

###  38410_CC_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-9.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-10.png" width="50%" />

###  38494_CC_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-11.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-12.png" width="50%" />

###  08963_CC_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-13.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-14.png" width="50%" />

###  08964_CC_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-15.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-16.png" width="50%" />

###  08967_CC_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-17.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-18.png" width="50%" />

###  08974_CC_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-19.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-20.png" width="50%" />

###  48287_CC_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-21.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-22.png" width="50%" />

###  48288_CC_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-23.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-24.png" width="50%" />

###  00001_CC_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-25.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-26.png" width="50%" />

###  00002_CC_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-27.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-28.png" width="50%" />

###  00003_CC_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-29.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-30.png" width="50%" />

###  00004_CC_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-31.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-32.png" width="50%" />

###  34183_CC_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-33.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-34.png" width="50%" />

###  38490_CC_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-35.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-36.png" width="50%" />

###  08961_CC_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-37.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-38.png" width="50%" />

###  08962_CC_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-39.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-40.png" width="50%" />

###  08971_CC_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-41.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-42.png" width="50%" />

###  48276_CC_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-43.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-44.png" width="50%" />

###  48285_CC_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-45.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-46.png" width="50%" />

###  48286_CC_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-47.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-48.png" width="50%" />

###  34178_CT_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-49.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-50.png" width="50%" />

###  34179_CT_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-51.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-52.png" width="50%" />

###  34194_CT_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-53.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-54.png" width="50%" />

###  34198_CT_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-55.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-56.png" width="50%" />

###  38405_CT_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-57.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-58.png" width="50%" />

###  38496_CT_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-59.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-60.png" width="50%" />

###  08965_CT_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-61.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-62.png" width="50%" />

###  08966_CT_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-63.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-64.png" width="50%" />

###  08975_CT_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-65.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-66.png" width="50%" />

###  08976_CT_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-67.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-68.png" width="50%" />

###  48283_CT_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-69.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-70.png" width="50%" />

###  48284_CT_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-71.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-72.png" width="50%" />

###  34133_CT_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-73.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-74.png" width="50%" />

###  34134_CT_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-75.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-76.png" width="50%" />

###  34163_CT_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-77.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-78.png" width="50%" />

###  34186_CT_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-79.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-80.png" width="50%" />

###  34187_CT_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-81.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-82.png" width="50%" />

###  38403_CT_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-83.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-84.png" width="50%" />

###  08959_CT_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-85.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-86.png" width="50%" />

###  08960_CT_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-87.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-88.png" width="50%" />

###  48273_CT_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-89.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-90.png" width="50%" />

###  48280_CT_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-91.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-92.png" width="50%" />

###  48281_CT_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-93.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-94.png" width="50%" />

###  48282_CT_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-95.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-96.png" width="50%" />

###  34160_TT_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-97.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-98.png" width="50%" />

###  34162_TT_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-99.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-100.png" width="50%" />

###  34197_TT_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-101.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-102.png" width="50%" />

###  38406_TT_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-103.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-104.png" width="50%" />

###  38493_TT_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-105.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-106.png" width="50%" />

###  38495_TT_F_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-107.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-108.png" width="50%" />

###  08945_TT_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-109.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-110.png" width="50%" />

###  08973_TT_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-111.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-112.png" width="50%" />

###  48277_TT_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-113.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-114.png" width="50%" />

###  48278_TT_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-115.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-116.png" width="50%" />

###  48279_TT_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-117.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-118.png" width="50%" />

###  48289_TT_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-119.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-120.png" width="50%" />

###  55487_TT_F_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-121.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-122.png" width="50%" />

###  34157_TT_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-123.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-124.png" width="50%" />

###  34158_TT_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-125.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-126.png" width="50%" />

###  34177_TT_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-127.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-128.png" width="50%" />

###  34184_TT_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-129.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-130.png" width="50%" />

###  34199_TT_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-131.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-132.png" width="50%" />

###  34200_TT_M_18 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-133.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-134.png" width="50%" />

###  08946_TT_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-135.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-136.png" width="50%" />

###  08992_TT_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-137.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-138.png" width="50%" />

###  48274_TT_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-139.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-140.png" width="50%" />

###  48275_TT_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-141.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-142.png" width="50%" />

###  55473_TT_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-143.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-144.png" width="50%" />

###  55477_TT_M_6 
<img src="RRBS_1_Processing_QC_files/figure-html/qc-145.png" width="50%" /><img src="RRBS_1_Processing_QC_files/figure-html/qc-146.png" width="50%" />

```r
rm(raw_meth)
```

## Output
Saving methylation objects for subsequent analyses.

```r
saveRDS(united_meth, file="output/RRBS/1_Processing_QC/united_meth.RDS")
saveRDS(site_meth, file="output/RRBS/1_Processing_QC/persite_meth.RDS")
write_csv(data.frame(site_meth), file="output/RRBS/1_Processing_QC/RRBS_persite_meth.csv")
```

Uploading percent methylation per site to [Synapse](https://www.synapse.org/#!Synapse:syn23573590/wiki/607402) as csv file.

```r
synLogin() 

file <- File("output/RRBS/1_Processing_QC/RRBS_persite_meth.csv",
             contentType = "text/plain",
             description = "RRBS Percent methylation per site per sample",
             parent = "syn25174486")
provenance <- Activity(used = "syn25174517",
                       executed = "https://github.com/TheJacksonLaboratory/MTHFR_C667T/blob/master/RRBS_1_Processing_QC.Rmd")
file <- synStore(file, activity=provenance)
```
